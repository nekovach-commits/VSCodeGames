<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TRS-80 Model 100 - Kindle Compatible</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/trs80-keyboard.css">
</head>
<body>
  <div id="retro-container" tabindex="0">
    <canvas id="retro-canvas"></canvas>
    
    <div id="keyboard-area">
      <!-- TRS-80 Model 100 On-Screen Keyboard -->
      <div id="trs80-keyboard-container" class="trs80-keyboard" style="display: block;">
        <div class="keyboard-info">
          <span class="keyboard-title">TRS-80 MODEL 100 KEYBOARD</span>
          <span class="keyboard-instructions">Tap keys to type ‚Ä¢ Arrow keys navigate ‚Ä¢ ESC clears screen</span>
        </div>
        
        <!-- Function Keys Row -->
        <div class="keyboard-section function-section">
          <div class="keyboard-row function-row">
            <button class="trs80-key function-key" data-key="F1">F1</button>
            <button class="trs80-key function-key" data-key="F2">F2</button>
            <button class="trs80-key function-key" data-key="F3">F3</button>
            <button class="trs80-key function-key" data-key="F4">F4</button>
            <button class="trs80-key function-key" data-key="F5">F5</button>
            <button class="trs80-key function-key" data-key="F6">F6</button>
            <button class="trs80-key function-key" data-key="F7">F7</button>
            <button class="trs80-key function-key" data-key="F8">F8</button>
          </div>
        </div>
        
        <!-- Main Keyboard Section -->
        <div class="keyboard-section main-section">
          <!-- Number Row -->
          <div class="keyboard-row number-row">
            <button class="trs80-key" data-key="1">1<span class="key-symbol">!</span></button>
            <button class="trs80-key" data-key="2">2<span class="key-symbol">@</span></button>
            <button class="trs80-key" data-key="3">3<span class="key-symbol">#</span></button>
            <button class="trs80-key" data-key="4">4<span class="key-symbol">$</span></button>
            <button class="trs80-key" data-key="5">5<span class="key-symbol">%</span></button>
            <button class="trs80-key" data-key="6">6<span class="key-symbol">^</span></button>
            <button class="trs80-key" data-key="7">7<span class="key-symbol">&</span></button>
            <button class="trs80-key" data-key="8">8<span class="key-symbol">*</span></button>
            <button class="trs80-key" data-key="9">9<span class="key-symbol">(</span></button>
            <button class="trs80-key" data-key="0">0<span class="key-symbol">)</span></button>
            <button class="trs80-key" data-key="-">-<span class="key-symbol">_</span></button>
            <button class="trs80-key" data-key="=">=<span class="key-symbol">+</span></button>
            <button class="trs80-key backspace-key" data-key="Backspace">BACKSPACE</button>
          </div>
          
          <!-- QWERTY Top Row -->
          <div class="keyboard-row qwerty-row">
            <button class="trs80-key tab-key" data-key="Tab">TAB</button>
            <button class="trs80-key" data-key="q">Q</button>
            <button class="trs80-key" data-key="w">W</button>
            <button class="trs80-key" data-key="e">E</button>
            <button class="trs80-key" data-key="r">R</button>
            <button class="trs80-key" data-key="t">T</button>
            <button class="trs80-key" data-key="y">Y</button>
            <button class="trs80-key" data-key="u">U</button>
            <button class="trs80-key" data-key="i">I</button>
            <button class="trs80-key" data-key="o">O</button>
            <button class="trs80-key" data-key="p">P</button>
            <button class="trs80-key" data-key="[">[<span class="key-symbol">{</span></button>
            <button class="trs80-key" data-key="]">]<span class="key-symbol">}</span></button>
          </div>
          
          <!-- QWERTY Middle Row -->
          <div class="keyboard-row qwerty-row">
            <button class="trs80-key caps-key" data-key="CapsLock">CAPS</button>
            <button class="trs80-key" data-key="a">A</button>
            <button class="trs80-key" data-key="s">S</button>
            <button class="trs80-key" data-key="d">D</button>
            <button class="trs80-key" data-key="f">F</button>
            <button class="trs80-key" data-key="g">G</button>
            <button class="trs80-key" data-key="h">H</button>
            <button class="trs80-key" data-key="j">J</button>
            <button class="trs80-key" data-key="k">K</button>
            <button class="trs80-key" data-key="l">L</button>
            <button class="trs80-key" data-key=";">;<span class="key-symbol">:</span></button>
            <button class="trs80-key" data-key="'">'<span class="key-symbol">"</span></button>
            <button class="trs80-key enter-key" data-key="Enter">ENTER</button>
          </div>
          
          <!-- QWERTY Bottom Row -->
          <div class="keyboard-row qwerty-row">
            <button class="trs80-key shift-key" data-key="Shift">SHIFT</button>
            <button class="trs80-key" data-key="z">Z</button>
            <button class="trs80-key" data-key="x">X</button>
            <button class="trs80-key" data-key="c">C</button>
            <button class="trs80-key" data-key="v">V</button>
            <button class="trs80-key" data-key="b">B</button>
            <button class="trs80-key" data-key="n">N</button>
            <button class="trs80-key" data-key="m">M</button>
            <button class="trs80-key" data-key=",">,<span class="key-symbol">&lt;</span></button>
            <button class="trs80-key" data-key=".">.<span class="key-symbol">&gt;</span></button>
            <button class="trs80-key" data-key="/">/<span class="key-symbol">?</span></button>
            <button class="trs80-key shift-key" data-key="Shift">SHIFT</button>
          </div>
          
          <!-- Control Row -->
          <div class="keyboard-row control-row">
            <button class="trs80-key ctrl-key" data-key="Control">CTRL</button>
            <button class="trs80-key space-key" data-key=" ">SPACE</button>
            <button class="trs80-key esc-key" data-key="Escape">ESC</button>
          </div>
        </div>
        
        <!-- Arrow Keys Section -->
        <div class="keyboard-section arrow-section">
          <div class="arrow-cluster">
            <div class="arrow-row">
              <button class="trs80-key arrow-key" data-key="ArrowUp">‚Üë</button>
            </div>
            <div class="arrow-row">
              <button class="trs80-key arrow-key" data-key="ArrowLeft">‚Üê</button>
              <button class="trs80-key arrow-key" data-key="ArrowDown">‚Üì</button>
              <button class="trs80-key arrow-key" data-key="ArrowRight">‚Üí</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Desktop Info -->
      <div id="desktop-info" style="margin-top: 15px; display: none;">
        <p><strong>TRS-80 MODEL 100 - PORTABLE COMPUTER (KINDLE COMPATIBLE)</strong></p>
        <p>Resolution: <span id="resolution-info">Loading...</span></p>
        <div id="debug-info" style="margin-top: 10px; font-size: 10px; color: #666;"></div>
      </div>
    </div>
  </div>

  <!-- Complete Kindle-Compatible TRS-80 System -->
  <script>
    console.log('üöÄ Starting Kindle-compatible TRS-80 system...');
    
    // Initialize immediately
    document.addEventListener('DOMContentLoaded', function() {
      initializeTRS80();
    });
    
    // Also run immediately in case DOMContentLoaded already fired
    if (document.readyState !== 'loading') {
      initializeTRS80();
    }
    
    function initializeTRS80() {
      console.log('üîß Initializing complete TRS-80 system for Kindle...');
      
      // Update resolution info
      updateResolutionInfo();
      window.addEventListener('resize', updateResolutionInfo);
      
      const canvas = document.getElementById('retro-canvas');
      if (!canvas) {
        console.error('‚ùå Canvas not found!');
        return;
      }
      
      // Set up canvas
      canvas.width = 1000;
      canvas.height = 360;
      const ctx = canvas.getContext('2d');
      
      // TRS-80 system state
      const trs80 = {
        cursorRow: 0,
        cursorCol: 0,
        textBuffer: [],
        cursorVisible: true,
        lastBlinkTime: Date.now(),
        
        init: function() {
          console.log('üìù Initializing text buffer...');
          for (let i = 0; i < 25; i++) {
            this.textBuffer[i] = new Array(40).fill(' ');
          }
          this.render();
          
          // Add welcome message
          const welcome = 'TRS-80 MODEL 100 - KINDLE COLORSOFT READY';
          for (let i = 0; i < welcome.length; i++) {
            this.addChar(welcome[i]);
          }
          this.addChar('\n');
          this.addChar('\n');
          console.log('‚úÖ TRS-80 system initialized successfully');
        },
        
        addChar: function(char) {
          console.log('üìù Adding character:', char);
          
          if (char === '\n' || char === 'Enter') {
            this.cursorRow++;
            this.cursorCol = 0;
            if (this.cursorRow >= 25) this.cursorRow = 24;
          } else if (char === 'Backspace') {
            if (this.cursorCol > 0) {
              this.cursorCol--;
              this.textBuffer[this.cursorRow][this.cursorCol] = ' ';
            } else if (this.cursorRow > 0) {
              this.cursorRow--;
              this.cursorCol = 39;
              this.textBuffer[this.cursorRow][this.cursorCol] = ' ';
            }
          } else if (char === 'Escape') {
            for (let i = 0; i < 25; i++) {
              this.textBuffer[i] = new Array(40).fill(' ');
            }
            this.cursorRow = 0;
            this.cursorCol = 0;
          } else if (char === 'ArrowUp' && this.cursorRow > 0) {
            this.cursorRow--;
          } else if (char === 'ArrowDown' && this.cursorRow < 24) {
            this.cursorRow++;
          } else if (char === 'ArrowLeft' && this.cursorCol > 0) {
            this.cursorCol--;
          } else if (char === 'ArrowRight' && this.cursorCol < 39) {
            this.cursorCol++;
          } else if (char === 'Tab') {
            for (let i = 0; i < 4 && this.cursorCol < 40; i++) {
              this.textBuffer[this.cursorRow][this.cursorCol] = ' ';
              this.cursorCol++;
            }
          } else if (char === ' ') {
            this.textBuffer[this.cursorRow][this.cursorCol] = ' ';
            this.cursorCol++;
            if (this.cursorCol >= 40) {
              this.cursorCol = 0;
              this.cursorRow++;
              if (this.cursorRow >= 25) this.cursorRow = 24;
            }
          } else if (char && char.length === 1) {
            this.textBuffer[this.cursorRow][this.cursorCol] = char;
            this.cursorCol++;
            if (this.cursorCol >= 40) {
              this.cursorCol = 0;
              this.cursorRow++;
              if (this.cursorRow >= 25) this.cursorRow = 24;
            }
          }
          this.render();
        },
        
        render: function() {
          // Clear screen
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          // Draw border
          ctx.fillStyle = '#000000';
          ctx.fillRect(0, 0, canvas.width, 20);
          ctx.fillRect(0, canvas.height - 20, canvas.width, 20);
          ctx.fillRect(0, 0, 20, canvas.height);
          ctx.fillRect(canvas.width - 20, 0, 20, canvas.height);
          
          // Draw text
          ctx.font = '16px Courier New';
          ctx.fillStyle = '#000000';
          for (let row = 0; row < Math.min(20, this.textBuffer.length); row++) {
            for (let col = 0; col < 40; col++) {
              const char = this.textBuffer[row][col];
              if (char && char !== ' ') {
                const x = 30 + col * 24;
                const y = 50 + row * 16;
                ctx.fillText(char, x, y);
              }
            }
          }
          
          // Handle cursor blinking
          const currentTime = Date.now();
          if (currentTime - this.lastBlinkTime > 500) {
            this.cursorVisible = !this.cursorVisible;
            this.lastBlinkTime = currentTime;
          }
          
          // Draw cursor
          if (this.cursorVisible && this.cursorRow < 20) {
            const cursorX = 30 + this.cursorCol * 24;
            const cursorY = 35 + this.cursorRow * 16;
            ctx.fillStyle = '#000000';
            ctx.fillRect(cursorX, cursorY, 24, 16);
            
            const charAtCursor = this.textBuffer[this.cursorRow][this.cursorCol];
            if (charAtCursor && charAtCursor !== ' ') {
              ctx.fillStyle = '#ffffff';
              ctx.fillText(charAtCursor, cursorX, cursorY + 12);
            }
          }
        }
      };
      
      // Initialize system
      trs80.init();
      
      // Physical keyboard
      document.addEventListener('keydown', function(e) {
        console.log('‚å®Ô∏è  Physical key:', e.key);
        trs80.addChar(e.key);
        e.preventDefault();
      });
      
      // On-screen keyboard
      console.log('üéÆ Setting up on-screen keyboard...');
      const keyButtons = document.querySelectorAll('.trs80-key');
      console.log('Found', keyButtons.length, 'keyboard buttons');
      
      keyButtons.forEach(function(button, index) {
        const keyValue = button.getAttribute('data-key');
        console.log('Setting up button', index, 'with key:', keyValue);
        
        // Click events
        button.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('üñ±Ô∏è  Click key:', keyValue);
          trs80.addChar(keyValue);
        });
        
        // Touch events for Kindle
        let touchHandled = false;
        
        button.addEventListener('touchstart', function(e) {
          e.preventDefault();
          e.stopPropagation();
          touchHandled = false;
          button.style.transform = 'scale(0.95)';
          button.style.backgroundColor = '#d0d0d0';
          console.log('üëÜ Touch start:', keyValue);
        }, { passive: false });
        
        button.addEventListener('touchend', function(e) {
          e.preventDefault();
          e.stopPropagation();
          button.style.transform = 'scale(1)';
          button.style.backgroundColor = '';
          
          if (!touchHandled) {
            touchHandled = true;
            console.log('üëÜ Touch end:', keyValue);
            setTimeout(function() {
              trs80.addChar(keyValue);
            }, 50);
          }
        }, { passive: false });
        
        button.addEventListener('touchcancel', function(e) {
          e.preventDefault();
          button.style.transform = 'scale(1)';
          button.style.backgroundColor = '';
          touchHandled = true;
          console.log('üëÜ Touch cancel:', keyValue);
        }, { passive: false });
      });
      
      // Animation loop
      function animate() {
        trs80.render();
        requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);
      
      // Make globally available
      window.trs80 = trs80;
      console.log('üéØ TRS-80 system ready!');
    }
    
    function updateResolutionInfo() {
      const resolutionInfo = document.getElementById('resolution-info');
      const debugInfo = document.getElementById('debug-info');
      
      if (resolutionInfo) {
        const info = [
          window.innerWidth + '√ó' + window.innerHeight,
          'Screen: ' + screen.width + '√ó' + screen.height,
          'DPR: ' + (window.devicePixelRatio || 1),
          'Touch: ' + ('ontouchstart' in window ? 'Yes' : 'No')
        ].join(' ‚Ä¢ ');
        resolutionInfo.textContent = info;
      }
      
      if (debugInfo) {
        const ua = navigator.userAgent;
        const isMobile = /Mobi|Android|iPhone|iPad|Kindle|Silk|ColorSoft/i.test(ua);
        const hasTouch = 'ontouchstart' in window;
        const isKindle = ua.toLowerCase().includes('kindle') || ua.toLowerCase().includes('silk');
        
        debugInfo.innerHTML = 
          '<strong>Debug Info:</strong><br>' +
          'User Agent: ' + ua.substring(0, 100) + '...<br>' +
          'Mobile Detected: ' + isMobile + '<br>' +
          'Touch Support: ' + hasTouch + '<br>' +
          'Kindle Detected: ' + isKindle + '<br>' +
          'Window Size: ' + window.innerWidth + ' √ó ' + window.innerHeight + '<br>';
      }
    }
  </script>
</body>
</html>