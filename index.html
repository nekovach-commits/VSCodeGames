<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="cache-bust" content="v2025-09-24-2">
  <title>TRS-80 Model 100 Emulator - Updated 2025-09-24</title>
  <link rel="stylesheet" href="style.css">
</head>
<body style="background: #ffffff !important; color: #000000 !important;">
  <div id="retro-container" tabindex="0" style="background: #ffffff !important;">
    <canvas id="retro-canvas" style="background: #ffffff !important; border: 3px solid #000000 !important; cursor: text;"></canvas>
    
    <!-- Kindle Keyboard Input -->
    <input type="text" id="kindle-input" placeholder="Tap here to open Kindle keyboard and type..." 
           style="width: 100%; max-width: 500px; padding: 10px; margin: 10px 0; font-family: 'Courier New', monospace; font-size: 16px; border: 2px solid #000; border-radius: 3px;">
    
    <div style="font-size: 12px; color: #666; margin-top: 10px; text-align: center;">
      ðŸ’¡ <strong>Kindle Users:</strong> Type in the input box above - text will appear on TRS-80 screen<br>
      <span id="status-msg" style="color: #006600;">System Status: Loading...</span>
    </div>
    
    <script>
      // Immediate canvas sizing - runs before modules load
      const canvas = document.getElementById('retro-canvas');
      const screenW = window.screen.width;
      const screenH = window.screen.height;
      console.log('Immediate sizing - Screen:', screenW + 'Ã—' + screenH);
      
      let pixelSize = 4; // Default
      if (screenW === 636 && screenH === 848) {
        pixelSize = 2; // Kindle ColorSoft
        console.log('âœ“ IMMEDIATE: Kindle ColorSoft detected');
      } else if (screenW <= 768) {
        pixelSize = 2; // Mobile
        console.log('âœ“ IMMEDIATE: Mobile detected');
      }
      
      const width = (40 * 6 * pixelSize) + 20;
      const height = (10 * 8 * pixelSize) + 20;
      
      canvas.width = width;
      canvas.height = height;
      console.log('âœ“ IMMEDIATE: Canvas set to', width + 'Ã—' + height);
      
      // Kindle Input Handler
      const kindleInput = document.getElementById('kindle-input');
      let inputBuffer = '';
      
      kindleInput.addEventListener('input', function(e) {
        const newValue = e.target.value;
        console.log('Input changed:', newValue);
        
        // Find what was added (handle typing and pasting)
        if (newValue.length > inputBuffer.length) {
          const addedText = newValue.slice(inputBuffer.length);
          console.log('Added text:', addedText);
          
          // Add each character to TRS-80
          for (let char of addedText) {
            if (window.trs80 && window.trs80.keyboard) {
              console.log('Sending to TRS-80:', char);
              window.trs80.keyboard.processKeyInput(char);
            } else {
              console.log('TRS-80 not ready, queuing:', char);
              // Queue for when system is ready
              window.pendingInput = window.pendingInput || [];
              window.pendingInput.push(char);
            }
          }
          
          if (window.trs80 && window.trs80.display) {
            window.trs80.display.render();
          }
        }
        
        // Clear the input field to prevent duplicate display
        setTimeout(() => {
          e.target.value = '';
          inputBuffer = '';
        }, 50);
        
        inputBuffer = newValue;
      });
      
      kindleInput.addEventListener('keydown', function(e) {
        console.log('Key pressed:', e.key);
        
        if (e.key === 'Backspace') {
          console.log('Processing backspace');
          if (window.trs80 && window.trs80.keyboard) {
            window.trs80.keyboard.processKeyInput('Backspace');
            window.trs80.display.render();
          }
          // Update our buffer
          inputBuffer = e.target.value.slice(0, -1);
          
        } else if (e.key === 'Enter') {
          console.log('Processing enter');
          if (window.trs80 && window.trs80.keyboard) {
            window.trs80.keyboard.processKeyInput('Enter');
            window.trs80.display.render();
          }
          // Clear input and buffer
          e.target.value = '';
          inputBuffer = '';
          e.preventDefault();
        }
      });
      
      // Process any queued input when TRS-80 system is ready
      window.addEventListener('load', function() {
        setTimeout(function() {
          if (window.trs80 && window.trs80.keyboard && window.trs80.display) {
            console.log('âœ“ TRS-80 system loaded successfully');
            document.getElementById('status-msg').textContent = 'System Status: âœ“ Ready for input';
            document.getElementById('status-msg').style.color = '#006600';
            
            if (window.pendingInput && window.pendingInput.length > 0) {
              console.log('Processing queued input:', window.pendingInput);
              for (let char of window.pendingInput) {
                window.trs80.keyboard.processKeyInput(char);
              }
              window.trs80.display.render();
              window.pendingInput = [];
            }
          } else {
            console.log('âœ— TRS-80 system failed to load');
            document.getElementById('status-msg').textContent = 'System Status: âœ— Load Failed';
            document.getElementById('status-msg').style.color = '#cc0000';
          }
        }, 2000); // Wait 2 seconds for modules to load
      });
    </script>
    
    <div id="keyboard-area" style="background: #ffffff !important; color: #000000 !important;">
      <!-- Desktop Info -->
      <div id="desktop-info" style="margin-top: 15px; color: #000000 !important;">
        <p><strong>TRS-80 MODEL 100 - PORTABLE COMPUTER</strong></p>
        <p>Type anything â€¢ ENTER: new line â€¢ ESC: clear â€¢ BACKSPACE: delete â€¢ Arrow keys: navigate</p>
        <p>Resolution: <span id="resolution-info">Loading...</span></p>
        <div id="debug-info" style="margin-top: 10px; font-size: 10px; color: #666; font-family: monospace;">
          <div>Screen Resolution: <span id="screen-res">Loading...</span></div>
          <div>Canvas Size: <span id="canvas-size">Loading...</span></div>
          <div>Expected Size: <span id="expected-size">Loading...</span></div>
          <div>Device Type: <span id="device-type">Loading...</span></div>
          <div>Scale Factor: <span id="scale-factor">Loading...</span></div>
          <div>Pixel Scale: <span id="pixel-scale">Loading...</span></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function updateResolutionInfo() {
      const resolutionInfo = document.getElementById('resolution-info');
      
      if (resolutionInfo) {
        const info = [
          `${window.innerWidth}Ã—${window.innerHeight}`,
          `Screen: ${screen.width}Ã—${screen.height}`,
          `DPR: ${window.devicePixelRatio || 1}`,
          `Touch: ${'ontouchstart' in window ? 'Yes' : 'No'}`
        ].join(' â€¢ ');
        resolutionInfo.textContent = info;
      }
      
      // Update individual debug fields
      const canvas = document.getElementById('retro-canvas');
      if (canvas) {
        const computedStyle = window.getComputedStyle(canvas);
        
        // Screen Resolution
        const screenRes = document.getElementById('screen-res');
        if (screenRes) screenRes.textContent = `${screen.width}Ã—${screen.height}`;
        
        // Canvas Size
        const canvasSize = document.getElementById('canvas-size');
        if (canvasSize) canvasSize.textContent = `${canvas.width}Ã—${canvas.height}`;
        
        // Expected Size (for Kindle: 40Ã—6Ã—2 + 20 = 500Ã—180)
        const expectedSize = document.getElementById('expected-size');
        if (expectedSize) {
          const width = screen.width;
          const height = screen.height;
          let pixelScale = 4; // Default
          if (width === 636 && height === 848) pixelScale = 2; // Kindle
          else if (width <= 768) pixelScale = 2; // Mobile
          
          const expectedW = (40 * 6 * pixelScale) + 20;
          const expectedH = (10 * 8 * pixelScale) + 20;
          expectedSize.textContent = `${expectedW}Ã—${expectedH}`;
        }
        
        // Device Type Detection
        const deviceType = document.getElementById('device-type');
        if (deviceType) {
          let type = 'Unknown';
          const width = screen.width;
          const height = screen.height;
          if (width === 636 && height === 848) {
            type = 'Kindle ColorSoft';
          } else if (width <= 768) {
            type = 'Mobile';
          } else if (width <= 1024) {
            type = 'Tablet';
          } else {
            type = 'Desktop';
          }
          deviceType.textContent = type;
        }
        
        // Scale Factor
        const scaleFactor = document.getElementById('scale-factor');
        if (scaleFactor) {
          const dpr = window.devicePixelRatio || 1;
          const scaleX = canvas.offsetWidth / canvas.width;
          const scaleY = canvas.offsetHeight / canvas.height;
          scaleFactor.textContent = `DPR:${dpr} Display:${scaleX.toFixed(2)}Ã—${scaleY.toFixed(2)}`;
        }
        
        // Pixel Scale
        const pixelScaleEl = document.getElementById('pixel-scale');
        if (pixelScaleEl) {
          const width = screen.width;
          const height = screen.height;
          let pixelScale = 4;
          if (width === 636 && height === 848) pixelScale = 2;
          else if (width <= 768) pixelScale = 2;
          pixelScaleEl.textContent = `${pixelScale}Ã—${pixelScale}`;
        }
        
        // Max Width/Height - remove these
        const maxWidth = document.getElementById('max-width');
        const maxHeight = document.getElementById('max-height');
        if (maxWidth) maxWidth.textContent = computedStyle.maxWidth;
        if (maxHeight) maxHeight.textContent = computedStyle.maxHeight;
      }
    }
    
    // Update resolution immediately and on resize
    updateResolutionInfo();
    window.addEventListener('resize', updateResolutionInfo);
    
    // Also update after a short delay to catch canvas initialization
    setTimeout(updateResolutionInfo, 2000);
  </script>

  <script type="module" src="js/trs80-main.js"></script>
  
  <!-- Fallback non-module TRS-80 system for Kindle compatibility -->
  <script>
    console.log('Loading fallback TRS-80 system...');
    
    // TRS-80 Model 100 5x7 Font Data (subset for common characters)
    const FONT_DATA = {
      ' ': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
      '!': [0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x00],
      '"': [0x0A, 0x0A, 0x0A, 0x00, 0x00, 0x00, 0x00],
      '#': [0x0A, 0x0A, 0x1F, 0x0A, 0x1F, 0x0A, 0x0A],
      '$': [0x04, 0x0F, 0x14, 0x0E, 0x05, 0x1E, 0x04],
      '%': [0x18, 0x19, 0x02, 0x04, 0x08, 0x13, 0x03],
      '&': [0x0C, 0x12, 0x14, 0x08, 0x15, 0x12, 0x0D],
      '\'': [0x0C, 0x04, 0x08, 0x00, 0x00, 0x00, 0x00],
      '(': [0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02],
      ')': [0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08],
      '*': [0x00, 0x04, 0x15, 0x0E, 0x15, 0x04, 0x00],
      '+': [0x00, 0x04, 0x04, 0x1F, 0x04, 0x04, 0x00],
      ',': [0x00, 0x00, 0x00, 0x00, 0x0C, 0x04, 0x08],
      '-': [0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x00],
      '.': [0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C],
      '/': [0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x00],
      '0': [0x0E, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0E],
      '1': [0x04, 0x0C, 0x04, 0x04, 0x04, 0x04, 0x0E],
      '2': [0x0E, 0x11, 0x01, 0x02, 0x04, 0x08, 0x1F],
      '3': [0x1F, 0x02, 0x04, 0x02, 0x01, 0x11, 0x0E],
      '4': [0x02, 0x06, 0x0A, 0x12, 0x1F, 0x02, 0x02],
      '5': [0x1F, 0x10, 0x1E, 0x01, 0x01, 0x11, 0x0E],
      '6': [0x06, 0x08, 0x10, 0x1E, 0x11, 0x11, 0x0E],
      '7': [0x1F, 0x01, 0x02, 0x04, 0x08, 0x08, 0x08],
      '8': [0x0E, 0x11, 0x11, 0x0E, 0x11, 0x11, 0x0E],
      '9': [0x0E, 0x11, 0x11, 0x0F, 0x01, 0x02, 0x0C],
      ':': [0x00, 0x0C, 0x0C, 0x00, 0x0C, 0x0C, 0x00],
      ';': [0x00, 0x0C, 0x0C, 0x00, 0x0C, 0x04, 0x08],
      '<': [0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02],
      '=': [0x00, 0x00, 0x1F, 0x00, 0x1F, 0x00, 0x00],
      '>': [0x08, 0x04, 0x02, 0x01, 0x02, 0x04, 0x08],
      '?': [0x0E, 0x11, 0x01, 0x02, 0x04, 0x00, 0x04],
      '@': [0x0E, 0x11, 0x01, 0x0D, 0x15, 0x15, 0x0E],
      'A': [0x0E, 0x11, 0x11, 0x11, 0x1F, 0x11, 0x11],
      'B': [0x1E, 0x11, 0x11, 0x1E, 0x11, 0x11, 0x1E],
      'C': [0x0E, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0E],
      'D': [0x1C, 0x12, 0x11, 0x11, 0x11, 0x12, 0x1C],
      'E': [0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x1F],
      'F': [0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x10],
      'G': [0x0E, 0x11, 0x10, 0x17, 0x11, 0x11, 0x0F],
      'H': [0x11, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11],
      'I': [0x0E, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E],
      'J': [0x07, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0C],
      'K': [0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11],
      'L': [0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1F],
      'M': [0x11, 0x1B, 0x15, 0x15, 0x11, 0x11, 0x11],
      'N': [0x11, 0x11, 0x19, 0x15, 0x13, 0x11, 0x11],
      'O': [0x0E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E],
      'P': [0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x10],
      'Q': [0x0E, 0x11, 0x11, 0x15, 0x12, 0x0E, 0x01],
      'R': [0x1E, 0x11, 0x11, 0x1E, 0x14, 0x12, 0x11],
      'S': [0x0F, 0x10, 0x10, 0x0E, 0x01, 0x01, 0x1E],
      'T': [0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04],
      'U': [0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E],
      'V': [0x11, 0x11, 0x11, 0x11, 0x11, 0x0A, 0x04],
      'W': [0x11, 0x11, 0x11, 0x15, 0x15, 0x15, 0x0A],
      'X': [0x11, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x11],
      'Y': [0x11, 0x11, 0x11, 0x0A, 0x04, 0x04, 0x04],
      'Z': [0x1F, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1F],
      'a': [0x00, 0x00, 0x0E, 0x01, 0x0F, 0x11, 0x0F],
      'b': [0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x1E],
      'c': [0x00, 0x00, 0x0E, 0x10, 0x10, 0x11, 0x0E],
      'd': [0x01, 0x01, 0x0D, 0x13, 0x11, 0x11, 0x0F],
      'e': [0x00, 0x00, 0x0E, 0x11, 0x1F, 0x10, 0x0E],
      'f': [0x06, 0x09, 0x08, 0x1C, 0x08, 0x08, 0x08],
      'g': [0x00, 0x0F, 0x11, 0x0F, 0x01, 0x0E, 0x10],
      'h': [0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x11],
      'i': [0x04, 0x00, 0x0C, 0x04, 0x04, 0x04, 0x0E],
      'j': [0x02, 0x00, 0x06, 0x02, 0x02, 0x12, 0x0C],
      'k': [0x10, 0x10, 0x12, 0x14, 0x18, 0x14, 0x12],
      'l': [0x0C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E],
      'm': [0x00, 0x00, 0x1A, 0x15, 0x15, 0x11, 0x11],
      'n': [0x00, 0x00, 0x16, 0x19, 0x11, 0x11, 0x11],
      'o': [0x00, 0x00, 0x0E, 0x11, 0x11, 0x11, 0x0E],
      'p': [0x00, 0x00, 0x1E, 0x11, 0x1E, 0x10, 0x10],
      'q': [0x00, 0x00, 0x0D, 0x13, 0x0F, 0x01, 0x01],
      'r': [0x00, 0x00, 0x16, 0x19, 0x10, 0x10, 0x10],
      's': [0x00, 0x00, 0x0E, 0x10, 0x0E, 0x01, 0x1E],
      't': [0x08, 0x08, 0x1C, 0x08, 0x08, 0x09, 0x06],
      'u': [0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0D],
      'v': [0x00, 0x00, 0x11, 0x11, 0x11, 0x0A, 0x04],
      'w': [0x00, 0x00, 0x11, 0x11, 0x15, 0x15, 0x0A],
      'x': [0x00, 0x00, 0x11, 0x0A, 0x04, 0x0A, 0x11],
      'y': [0x00, 0x00, 0x11, 0x11, 0x0F, 0x01, 0x0E],
      'z': [0x00, 0x00, 0x1F, 0x02, 0x04, 0x08, 0x1F]
    };
    
    // Draw character using original TRS-80 bitmap font
    function drawChar(ctx, char, x, y, pixelSize, color) {
      const fontData = FONT_DATA[char];
      if (!fontData) return;
      
      ctx.fillStyle = color;
      
      for (let row = 0; row < 7; row++) {
        const rowData = fontData[row];
        for (let col = 0; col < 5; col++) {
          if (rowData & (1 << (4 - col))) {
            const pixelX = x + col * pixelSize;
            const pixelY = y + row * pixelSize;
            ctx.fillRect(pixelX, pixelY, pixelSize, pixelSize);
          }
        }
      }
    }
    
    // Simple TRS-80 Display System using real font data
    class SimpleTRS80 {
      constructor() {
        this.canvas = document.getElementById('retro-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.text = '';
        this.cursorPos = 0;
        this.pixelSize = 2; // For Kindle
        this.charWidth = 12; // 6 * 2 (5 pixels + 1 space, scaled 2x)
        this.charHeight = 16; // 8 * 2 (7 pixels + 1 space, scaled 2x)
        this.rows = [];
        this.currentRow = 0;
        this.currentCol = 0;
        
        // Initialize with empty rows - 40 chars wide to match TRS-80
        for (let i = 0; i < 10; i++) {
          this.rows[i] = '';
        }
        
        console.log('âœ“ Simple TRS-80 initialized');
        console.log(`Canvas: ${this.canvas.width}Ã—${this.canvas.height}`);
        console.log(`Character cell: ${this.charWidth}Ã—${this.charHeight} pixels`);
        console.log(`40 chars Ã— ${this.charWidth} = ${40 * this.charWidth} pixels + 20 border = ${40 * this.charWidth + 20} total`);
        this.render();
        
        // Start animation loop for blinking cursor
        setInterval(() => {
          this.render();
        }, 500);
      }
      
      addChar(char) {
        if (char === '\n' || char === 'Enter') {
          this.currentRow++;
          this.currentCol = 0;
          if (this.currentRow >= 10) {
            // Scroll up
            this.rows.shift();
            this.rows.push('');
            this.currentRow = 9;
          }
        } else if (char === 'Backspace') {
          if (this.currentCol > 0) {
            this.currentCol--;
            this.rows[this.currentRow] = this.rows[this.currentRow].slice(0, -1);
          } else if (this.currentRow > 0) {
            this.currentRow--;
            this.currentCol = this.rows[this.currentRow].length;
            this.rows[this.currentRow] = this.rows[this.currentRow].slice(0, -1);
          }
        } else if (char.length === 1) {
          // Regular character
          if (!this.rows[this.currentRow]) this.rows[this.currentRow] = '';
          this.rows[this.currentRow] += char;
          this.currentCol++;
          if (this.currentCol >= 40) {
            this.currentRow++;
            this.currentCol = 0;
            if (this.currentRow >= 10) {
              this.rows.shift();
              this.rows.push('');
              this.currentRow = 9;
            }
          }
        }
        this.render();
      }
      
      render() {
        // Clear canvas with white background
        this.ctx.fillStyle = '#ffffff';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Draw black border
        this.ctx.strokeStyle = '#000000';
        this.ctx.lineWidth = 2;
        this.ctx.strokeRect(1, 1, this.canvas.width-2, this.canvas.height-2);
        
        // Draw pixel-style text
        this.ctx.fillStyle = '#000000';
        
        for (let row = 0; row < 10; row++) {
          const line = this.rows[row] || '';
          for (let col = 0; col < line.length; col++) {
            const char = line[col];
            this.drawPixelChar(char, col, row);
          }
        }
        
        // Draw cursor
        this.drawCursor(this.currentCol, this.currentRow);
      }
      
      drawPixelChar(char, col, row) {
        const borderSize = 10;
        const x = borderSize + (col * this.charWidth);
        const y = borderSize + (row * this.charHeight);
        
        // Use original TRS-80 5Ã—7 bitmap font data
        drawChar(this.ctx, char, x, y, this.pixelSize, '#000000');
      }
      
      drawCursor(col, row) {
        const borderSize = 10;
        const x = borderSize + (col * this.charWidth);
        const y = borderSize + (row * this.charHeight);
        
        // Blinking cursor - only show every other blink cycle
        if (Math.floor(Date.now() / 500) % 2) {
          this.ctx.fillStyle = '#000000';
          // Draw cursor as a solid block in the 5Ã—7 area (not the full cell)
          for (let r = 0; r < 7; r++) {
            for (let c = 0; c < 5; c++) {
              this.ctx.fillRect(
                x + (c * this.pixelSize),
                y + (r * this.pixelSize),
                this.pixelSize,
                this.pixelSize
              );
            }
          }
        }
      }
    }
    
    // Initialize fallback system if modules fail
    setTimeout(function() {
      if (!window.trs80) {
        console.log('âš  ES6 modules failed, using fallback system');
        window.simpleTRS80 = new SimpleTRS80();
        document.getElementById('status-msg').textContent = 'System Status: âœ“ Fallback Ready';
        document.getElementById('status-msg').style.color = '#ff8800';
        
        // Update input handlers to use simple system
        window.trs80 = {
          keyboard: {
            processKeyInput: function(char) {
              console.log('Fallback processing:', char);
              window.simpleTRS80.addChar(char);
            }
          },
          display: {
            render: function() {
              window.simpleTRS80.render();
            }
          }
        };
      }
    }, 1000);
  </script>
</body>
</html>