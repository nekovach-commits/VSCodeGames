<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TRS-80 Model 100 Emulator</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #00ff00;
      font-family: monospace;
      overflow: hidden;
      user-select: none;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      max-width: 100%;
      padding: 10px;
      box-sizing: border-box;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 1000px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .status, .resolution-info {
      color: #0f0;
      font-size: 14px;
      background: rgba(0,0,0,0.8);
      padding: 5px 10px;
      border-radius: 3px;
      margin: 2px;
    }

    .resolution-info {
      color: #ff0;
    }

    .screen-container {
      background: #222;
      padding: 15px;
      border: 3px solid #666;
      border-radius: 5px;
      margin-bottom: 15px;
    }

    #retro-canvas {
      display: block;
      background: #000;
      border: 2px solid #333;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      max-width: 100%;
      height: auto;
    }

    .input-section {
      width: 100%;
      max-width: 800px;
      margin-top: 10px;
    }

    #native-input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: rgba(0, 50, 0, 0.9);
      color: #00ff00;
      border: 2px solid #00ff00;
      border-radius: 4px;
      font-family: monospace;
      outline: none;
      box-sizing: border-box;
    }

    #native-input:focus {
      background: rgba(0, 80, 0, 0.9);
      border-color: #00ff88;
      box-shadow: 0 0 8px rgba(0, 255, 0, 0.3);
    }

    .keyboard {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
      max-width: 800px;
      width: 100%;
      margin-top: 15px;
    }

    .trs80-key {
      background: #333;
      color: #fff;
      border: 2px solid #666;
      border-radius: 3px;
      padding: 12px 4px;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      min-height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .trs80-key:hover, .trs80-key:active {
      background: #555;
      border-color: #888;
    }

    .trs80-key.space-key {
      grid-column: span 4;
    }

    .instructions {
      color: #888;
      text-align: center;
      margin-top: 10px;
      font-size: 12px;
      padding: 8px;
      background: rgba(0,0,0,0.8);
      border-radius: 3px;
    }

    /* Desktop optimizations */
    @media screen and (min-width: 1000px) {
      .container {
        padding: 20px;
      }
      
      #retro-canvas {
        width: 800px;
        height: 300px;
      }
      
      .status, .resolution-info {
        font-size: 16px;
      }
      
      .trs80-key {
        padding: 15px 8px;
        font-size: 12px;
        min-height: 40px;
      }
      
      #native-input {
        font-size: 18px;
        padding: 15px;
      }
    }

    /* Kindle ColorSoft portrait optimizations */
    @media screen and (orientation: portrait) and (max-width: 1300px) {
      .container {
        padding: 8px;
      }
      
      #retro-canvas {
        width: 100%;
        max-width: 1200px;
        height: auto;
      }
      
      .keyboard {
        gap: 3px;
      }
      
      .trs80-key {
        padding: 10px 3px;
        font-size: 10px;
        min-height: 30px;
      }
      
      .status, .resolution-info {
        font-size: 16px;
      }
      
      #native-input {
        font-size: 18px;
        padding: 18px;
      }
      
      .instructions {
        font-size: 14px;
      }
    }

    /* Hide on-screen keyboard on devices with native keyboards */
    @media screen and (orientation: portrait) {
      .keyboard {
        display: none;
      }
      
      .instructions {
        display: block;
      }
    }

    @media screen and (orientation: landscape) {
      .instructions {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="status-bar">
      <div class="status" id="status">TRS-80 Model 100 Emulator - Initializing...</div>
      <div class="resolution-info" id="resolution">Detecting resolution...</div>
    </div>
    
    <div class="screen-container">
      <canvas id="retro-canvas" width="800" height="300"></canvas>
    </div>

    <div class="input-section">
      <input type="text" id="native-input" placeholder="Tap here to use native keyboard or use buttons below..." autocomplete="off" spellcheck="false">
    </div>

    <div class="instructions">
      <strong>Native Keyboard Mode:</strong> Tap the input field above to use your device's keyboard.
      Type normally - characters appear on the TRS-80 screen. Press Enter for new line, Backspace to delete.
    </div>

    <div class="keyboard">
      <!-- Row 1 -->
      <button class="trs80-key" data-key="1">1</button>
      <button class="trs80-key" data-key="2">2</button>
      <button class="trs80-key" data-key="3">3</button>
      <button class="trs80-key" data-key="4">4</button>
      <button class="trs80-key" data-key="5">5</button>
      <button class="trs80-key" data-key="6">6</button>
      <button class="trs80-key" data-key="7">7</button>
      <button class="trs80-key" data-key="8">8</button>
      <button class="trs80-key" data-key="9">9</button>
      <button class="trs80-key" data-key="0">0</button>

      <!-- Row 2 -->
      <button class="trs80-key" data-key="Q">Q</button>
      <button class="trs80-key" data-key="W">W</button>
      <button class="trs80-key" data-key="E">E</button>
      <button class="trs80-key" data-key="R">R</button>
      <button class="trs80-key" data-key="T">T</button>
      <button class="trs80-key" data-key="Y">Y</button>
      <button class="trs80-key" data-key="U">U</button>
      <button class="trs80-key" data-key="I">I</button>
      <button class="trs80-key" data-key="O">O</button>
      <button class="trs80-key" data-key="P">P</button>

      <!-- Row 3 -->
      <button class="trs80-key" data-key="A">A</button>
      <button class="trs80-key" data-key="S">S</button>
      <button class="trs80-key" data-key="D">D</button>
      <button class="trs80-key" data-key="F">F</button>
      <button class="trs80-key" data-key="G">G</button>
      <button class="trs80-key" data-key="H">H</button>
      <button class="trs80-key" data-key="J">J</button>
      <button class="trs80-key" data-key="K">K</button>
      <button class="trs80-key" data-key="L">L</button>
      <button class="trs80-key" data-key="Enter">ENTER</button>

      <!-- Row 4 -->
      <button class="trs80-key" data-key="Z">Z</button>
      <button class="trs80-key" data-key="X">X</button>
      <button class="trs80-key" data-key="C">C</button>
      <button class="trs80-key" data-key="V">V</button>
      <button class="trs80-key" data-key="B">B</button>
      <button class="trs80-key" data-key="N">N</button>
      <button class="trs80-key" data-key="M">M</button>
      <button class="trs80-key" data-key=",">,</button>
      <button class="trs80-key" data-key=".">.</button>
      <button class="trs80-key" data-key="Backspace">⌫</button>

      <!-- Row 5 -->
      <button class="trs80-key" data-key="-">-</button>
      <button class="trs80-key" data-key="=">=</button>
      <button class="trs80-key space-key" data-key=" ">SPACE</button>
      <button class="trs80-key" data-key="/">/</button>
      <button class="trs80-key" data-key="*">*</button>
      <button class="trs80-key" data-key="+">+</button>
      <button class="trs80-key" data-key="Escape">ESC</button>
    </div>
  </div>

  <!-- TRS-80 System -->
  <script type="module">
    // Enhanced device detection
    function detectDevice() {
      const ua = navigator.userAgent;
      const width = window.screen.width || window.innerWidth;
      const height = window.screen.height || window.innerHeight;
      
      const isKindle = /Kindle|Silk/.test(ua) || (width === 1264 && height === 1680);
      const isTablet = width >= 768 && width <= 1366;
      const isPortrait = height > width;
      
      console.log('Device Detection:', { ua, width, height, isKindle, isTablet, isPortrait });
      
      return { isKindle, isTablet, isPortrait, width, height };
    }

    // Display resolution info
    function updateResolution() {
      const device = detectDevice();
      const dpr = window.devicePixelRatio || 1;
      
      document.getElementById('resolution').innerHTML = `
        ${device.width}×${device.height} | DPR: ${dpr} | ${device.isKindle ? 'Kindle' : device.isTablet ? 'Tablet' : 'Desktop'}
      `;
    }

    updateResolution();
    setInterval(updateResolution, 5000);

    // Try to load modular system first
    import('./js/trs80-main.js').then(module => {
      console.log('✅ Modular TRS-80 system loaded successfully');
      document.getElementById('status').textContent = 'TRS-80 Model 100 Ready - Full System';
      
      // Set up native input handling for all devices
      setupNativeInput();
      
    }).catch(error => {
      console.log('⚠️ Module loading failed, using fallback system:', error);
      loadFallbackSystem();
    });

    function setupNativeInput() {
      const nativeInput = document.getElementById('native-input');
      let lastValue = '';
      
      nativeInput.addEventListener('input', function(e) {
        const currentValue = e.target.value;
        
        if (window.trs80 && window.trs80.display) {
          if (currentValue.length > lastValue.length) {
            const newChar = currentValue[currentValue.length - 1];
            window.trs80.display.addChar(newChar);
          } else if (currentValue.length < lastValue.length) {
            window.trs80.display.addChar('\b');
          }
        }
        
        lastValue = currentValue;
      });
      
      nativeInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          if (window.trs80 && window.trs80.display) {
            window.trs80.display.addChar('\n');
          }
          e.preventDefault();
        } else if (e.key === 'Escape') {
          if (window.trs80 && window.trs80.display) {
            window.trs80.display.clear();
          }
          nativeInput.value = '';
          lastValue = '';
          e.preventDefault();
        }
      });
      
      // Auto-focus on mobile/tablet devices
      const device = detectDevice();
      if (device.isKindle || device.isTablet || device.isPortrait) {
        setTimeout(() => nativeInput.focus(), 1000);
      }
      
      // Keep input focused when canvas is tapped
      document.getElementById('retro-canvas').addEventListener('click', () => {
        nativeInput.focus();
      });
    }

    function loadFallbackSystem() {
      console.log('Loading fallback TRS-80 system...');
      document.getElementById('status').textContent = 'TRS-80 Model 100 Ready - Fallback Mode';
      
      // Import fallback system code here if needed
      // For now, just set up basic functionality
      setupNativeInput();
    }
  </script>

  <!-- Fallback script for older browsers -->
  <script>
    // Basic fallback if modules fail completely
    window.addEventListener('load', function() {
      setTimeout(function() {
        if (!document.getElementById('status').textContent.includes('Ready')) {
          document.getElementById('status').textContent = 'TRS-80 Model 100 - Basic Mode (modules failed)';
          console.log('Using basic fallback mode');
        }
      }, 3000);
    });
  </script>
</body>
</html>