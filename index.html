<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="cache-bust" content="v2025-09-24-2">
  <title>TRS-80 Model 100 Emulator - Updated 2025-09-24</title>
  <link rel="stylesheet" href="style.css">
</head>
<body style="background: #ffffff !important; color: #000000 !important;">
  <div id="retro-container" tabindex="0" style="background: #ffffff !important;">
    <canvas id="retro-canvas" style="background: #ffffff !important; border: 1px solid #000000 !important; cursor: text;"></canvas>
    
    <input type="text" id="kindle-input" placeholder="Tap here to open Kindle keyboard and type..." 
           style="width: 100%; max-width: 500px; padding: 10px; margin: 10px 0; font-family: 'Courier New', monospace; font-size: 16px; border: 2px solid #000; border-radius: 3px;">
    
    <div style="font-size: 12px; color: #666; margin-top: 10px; text-align: center;">
      üí° <strong>Kindle Users:</strong> Type in the input box above - text will appear on TRS-80 screen<br>
      üé® <strong>Colors:</strong> Use COLOR 0-7 (Black,Red,Green,Yellow,Blue,Magenta,Cyan,White)<br>
      üìù <strong>BASIC:</strong> Try: PRINT "HELLO", COLOR 1, COLOR 2, PRINT "GREEN TEXT"<br>
      <span id="status-msg" style="color: #006600;">System Status: Loading...</span>
    </div>
    
    <script>
      // ========================================
      // DEVICE DETECTION & PIXEL SCALING
      // ========================================
      
      // Unified device detection and pixel size calculation
      function getDeviceInfo() {
        const w = window.screen.width;
        const h = window.screen.height;
        
        // Specific device resolutions - conservative for small screens
        if (w === 636 && h === 848) return { type: 'Kindle ColorSoft', pixelSize: 2 };
        if (w === 930 && h === 1240) return { type: 'Kindle Scribe', pixelSize: 3 };
        
        // General size categories - proper scaling for web
        if (w <= 768) return { type: 'Mobile', pixelSize: 1 };
        if (w <= 1024) return { type: 'Tablet', pixelSize: 2 };
        return { type: 'Desktop', pixelSize: 4 };  // Back to 4x for proper retro look
      }
      
      function getPixelSize() {
        return getDeviceInfo().pixelSize;
      }
      
      // Immediate canvas sizing - runs before modules load
      const canvas = document.getElementById('retro-canvas');
      const pixelSize = getPixelSize();
      
      // Optimized canvas size for perfect 6x8 character fit
      const charArea = { width: 40 * 6 * pixelSize, height: 20 * 8 * pixelSize };
      const border = 10; // 10px border on each side
      const width = charArea.width + (border * 2);
      const height = charArea.height + (border * 2);
      
      canvas.width = width;
      canvas.height = height;
      
      // Debug: Show what we're working with
      console.log('DEBUG: pixelSize =', pixelSize);
      console.log('DEBUG: charArea =', charArea);
      console.log('DEBUG: canvas size =', width, 'x', height);
      console.log('DEBUG: Expected chars = 40x20');
      console.log('DEBUG: Actual char size = 6x8 pixels each');
      console.log('‚úì GRID: 40√ó20 chars, 6√ó8 pixels each, scale=' + pixelSize);
      
      // Kindle Input Handler
      const kindleInput = document.getElementById('kindle-input');
      // Unified input handling - works same way for all systems
      let currentLine = '';
      let inputBuffer = '';
      let showingPrompt = false;

      // ========================================
      // APPLE IIE STYLE PROMPT SYSTEM
      // ========================================
      
      function showPrompt() {
        if (!showingPrompt) {
          UnifiedDisplay.addChar(']');
          showingPrompt = true;
          UnifiedDisplay.render();
        }
      }
      
      function hidePrompt() {
        if (showingPrompt) {
          // Remove the ] character by sending backspace
          UnifiedDisplay.addChar('Backspace');
          showingPrompt = false;
          UnifiedDisplay.render();
        }
      }

      // ========================================
      // UNIFIED DISPLAY ABSTRACTION LAYER
      // ========================================
      
      // Helper function to get ES6 display if available
      function getES6Display() {
        return window.trs80 && window.trs80.display ? window.trs80.display : null;
      }
      
      // Universal display interface - auto-detects which backend to use
      const UnifiedDisplay = {
        addChar: function(char) {
          if (window.simpleTRS80) {
            window.simpleTRS80.addChar(char);
          } else {
            const es6Display = getES6Display();
            if (es6Display && es6Display.addChar) {
              es6Display.addChar(char);
            }
          }
        },
        clearScreen: function() {
          if (window.simpleTRS80) {
            window.simpleTRS80.clearScreen();
          } else {
            const es6Display = getES6Display();
            if (es6Display && es6Display.clearScreen) {
              es6Display.clearScreen();
            }
          }
        },
        setTextColor: function(colorIndex) {
          if (window.simpleTRS80) {
            window.simpleTRS80.setTextColor(colorIndex);
          } else {
            const es6Display = getES6Display();
            if (es6Display && es6Display.setTextColor) {
              es6Display.setTextColor(colorIndex);
            }
          }
        },
        addText: function(text) {
          for (let i = 0; i < text.length; i++) {
            this.addChar(text[i]);
          }
        },
        render: function() {
          const es6Display = getES6Display();
          if (es6Display && es6Display.render) {
            es6Display.render();
          }
          // SimpleTRS80 renders automatically
        }
      };

      // ========================================
      // UNIFIED PROGRAM STORAGE ABSTRACTION
      // ========================================
      
      // Universal program storage - auto-detects which storage to use
      const UnifiedProgram = {
        storage: null,
        getStorage: function() {
          if (!this.storage) {
            if (window.trs80 && window.trs80.program) {
              this.storage = window.trs80.program;
            } else {
              this.storage = new Map();
            }
          }
          return this.storage;
        },
        set: function(lineNum, command) {
          this.getStorage().set(lineNum, command);
        },
        get: function(lineNum) {
          return this.getStorage().get(lineNum);
        },
        delete: function(lineNum) {
          this.getStorage().delete(lineNum);
        },
        clear: function() {
          this.getStorage().clear();
        },
        keys: function() {
          return this.getStorage().keys();
        },
        get size() {
          return this.getStorage().size;
        }
      };

      // ========================================
      // UNIFIED INPUT PROCESSING
      // ========================================
      
      // Unified input processing
      function processCharacter(char) {
        if (char === 'Backspace') {
          // Only allow backspace if there are characters to delete (protect the ] prompt)
          if (currentLine.length > 0) {
            currentLine = currentLine.slice(0, -1);
            UnifiedDisplay.addChar(char);
          }
          return;
        }

        if (char === 'Enter') {
          // Don't hide prompt - just move to new line and let it naturally disappear
          
          // Add newline ONLY for SimpleTRS80 (Kindle) - ES6 system handles this internally
          if (window.simpleTRS80 && !window.trs80) {
            UnifiedDisplay.addChar('\n');
          }
          
          if (currentLine.trim()) {
            // Process through SharedBasicProcessor
            if (window.SharedBasicProcessor) {
              window.SharedBasicProcessor.processLine(currentLine.trim(), UnifiedProgram, UnifiedDisplay);
            }
          } else {
            // Empty line - just add newline and show prompt again
            if (window.simpleTRS80 && !window.trs80) {
              // Already added newline above for Kindle
            } else {
              UnifiedDisplay.addChar('\n');
            }
          }
          
          currentLine = ''; // Clear line
          showingPrompt = false; // Reset prompt state since we moved to new line
          showPrompt(); // Show prompt for next input
          UnifiedDisplay.render();
          return;
        }

        // Regular character - don't hide prompt when typing, just add characters after ]
        if (char.length === 1) {
          currentLine += char;
          UnifiedDisplay.addChar(char);
        }
        UnifiedDisplay.render();
      }
      
      // ========================================
      // INPUT EVENT HANDLERS
      // ========================================
      
      kindleInput.addEventListener('input', function(e) {
        const newValue = e.target.value;
        
        // Find what was added (handle typing and pasting)
        if (newValue.length > inputBuffer.length) {
          const addedText = newValue.slice(inputBuffer.length);
          // Process each character through unified system
          for (let char of addedText) {
            processCharacter(char);
          }
        }
        
        // Find what was removed (backspace)
        if (newValue.length < inputBuffer.length) {
          const removedCount = inputBuffer.length - newValue.length;
          for (let i = 0; i < removedCount; i++) {
            processCharacter('Backspace');
          }
        }
        
        // Clear the input field to prevent duplicate display
        setTimeout(() => {
          e.target.value = '';
          inputBuffer = '';
        }, 50);
        
        inputBuffer = newValue;
      });

      // Handle Enter key specifically for command execution
      kindleInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          const currentInput = e.target.value.trim();
          if (currentInput) {
            // Set the current line and process Enter
            currentLine = currentInput;
            processCharacter('Enter');
          } else {
            processCharacter('Enter');
          }
          
          // Clear input field
          e.target.value = '';
          inputBuffer = '';
          e.preventDefault();
        } else if (e.key === 'Backspace') {
          // Handle backspace directly since input event might not fire reliably on Kindle
          if (currentLine.length > 0) {
            currentLine = currentLine.slice(0, -1);
            UnifiedDisplay.addChar('Backspace');
          }
        }
      });
    </script>
    
    <div id="keyboard-area" style="background: #ffffff !important; color: #000000 !important;">
      <!-- Desktop Info -->
      <div id="desktop-info" style="margin-top: 15px; color: #000000 !important;">
        <p><strong>TRS-80 MODEL 100 - PORTABLE COMPUTER</strong></p>
        <p>Type anything ‚Ä¢ ENTER: new line ‚Ä¢ ESC: clear ‚Ä¢ BACKSPACE: delete ‚Ä¢ Arrow keys: navigate</p>
        <p>Resolution: <span id="resolution-info">Loading...</span></p>
        <div id="debug-info" style="margin-top: 10px; font-size: 10px; color: #666; font-family: monospace;">
          <div>Screen Resolution: <span id="screen-res">Loading...</span></div>
          <div>Canvas Size: <span id="canvas-size">Loading...</span></div>
          <div>Expected Size: <span id="expected-size">Loading...</span></div>
          <div>Device Type: <span id="device-type">Loading...</span></div>
          <div>Scale Factor: <span id="scale-factor">Loading...</span></div>
          <div>Pixel Scale: <span id="pixel-scale">Loading...</span></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // RESOLUTION & DEVICE INFO FUNCTIONS
    // ========================================
    
    function updateResolutionInfo() {
      const resolutionInfo = document.getElementById('resolution-info');
      
      if (resolutionInfo) {
        const info = [
          `${window.innerWidth}√ó${window.innerHeight}`,
          `Screen: ${screen.width}√ó${screen.height}`,
          `DPR: ${window.devicePixelRatio || 1}`,
          `Touch: ${'ontouchstart' in window ? 'Yes' : 'No'}`
        ].join(' ‚Ä¢ ');
        resolutionInfo.textContent = info;
      }
      
      // Update individual debug fields
      const canvas = document.getElementById('retro-canvas');
      if (canvas) {
        const computedStyle = window.getComputedStyle(canvas);
        
        // Screen Resolution
        const screenRes = document.getElementById('screen-res');
        if (screenRes) screenRes.textContent = `${screen.width}√ó${screen.height}`;
        
        // Canvas Size
        const canvasSize = document.getElementById('canvas-size');
        if (canvasSize) canvasSize.textContent = `${canvas.width}√ó${canvas.height}`;
        
        // Expected Size
        const expectedSize = document.getElementById('expected-size');
        if (expectedSize) {
          const pixelScale = getPixelSize();
          const expectedW = (40 * 6 * pixelScale) + 20;
          const expectedH = (20 * 8 * pixelScale) + 20;
          expectedSize.textContent = `${expectedW}√ó${expectedH}`;
        }
        
        // Device Type Detection
        const deviceType = document.getElementById('device-type');
        if (deviceType) {
          deviceType.textContent = getDeviceInfo().type;
        }
        
        // Scale Factor
        const scaleFactor = document.getElementById('scale-factor');
        if (scaleFactor) {
          const dpr = window.devicePixelRatio || 1;
          const scaleX = canvas.offsetWidth / canvas.width;
          const scaleY = canvas.offsetHeight / canvas.height;
          scaleFactor.textContent = `DPR:${dpr} Display:${scaleX.toFixed(2)}√ó${scaleY.toFixed(2)}`;
        }
        
        // Pixel Scale
        const pixelScaleEl = document.getElementById('pixel-scale');
        if (pixelScaleEl) {
          const pixelScale = getPixelSize();
          pixelScaleEl.textContent = `${pixelScale}√ó${pixelScale}`;
        }
        
        // Max Width/Height - remove these
        const maxWidth = document.getElementById('max-width');
        const maxHeight = document.getElementById('max-height');
        if (maxWidth) maxWidth.textContent = computedStyle.maxWidth;
        if (maxHeight) maxHeight.textContent = computedStyle.maxHeight;
      }
    }
    
    // Update resolution immediately and on resize
    updateResolutionInfo();
    window.addEventListener('resize', updateResolutionInfo);
    
    // Also update after a short delay to catch canvas initialization
    setTimeout(updateResolutionInfo, 2000);
  </script>

  <script>
    // Debug ES6 module loading
    window.addEventListener('error', function(e) {
      console.error('Script error:', e.error, e.filename, e.lineno);
      document.getElementById('status-msg').textContent = 'System Status: ‚úó Script Error - ' + e.message;
      document.getElementById('status-msg').style.color = '#cc0000';
    });
    
    console.log('About to load TRS-80 main module...');
  </script>

  <script src="js/boot.js"></script>
</body>
</html>